<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        min-height: 100vh;
        padding: 30px;
        font-family: "Segoe UI", sans-serif;
      }

      .main-card {
        max-width: 1200px;
        margin: auto;
        background: #ffffff;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      }

      .chat-window {
        height: 460px;
        overflow-y: auto;
        padding: 15px;
        background: #fafafa;
        border-radius: 15px;
        border: 1px solid #ddd;
      }

      /* Chat Bubbles */
      .chat-bubble {
        max-width: 80%;
        padding: 12px 18px;
        margin-bottom: 12px;
        border-radius: 18px;
        font-size: 15px;
      }

      .user-bubble {
        background: #9c27b0;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 5px;
      }

      .bot-bubble {
        background: #e1bee7;
        color: #4a004e;
        margin-right: auto;
        border-bottom-left-radius: 5px;
      }

      .btn-primary {
        background-color: #9c27b0;
        border: none;
      }

      .btn-primary:hover {
        background-color: #7b1fa2;
      }

      .sidebar-card {
        border-radius: 15px;
        background: #faf4fc;
        border: 1px solid #d9c4e8;
      }

      .small-muted {
        color: #777;
        font-size: 14px;
      }
    </style>
  </head>

  <body>
    <section>
      <div class="main-card">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="fw-bold">üí¨ Emotion-Aware Chatbot</h3>
          <a
            href="{{ url_for('home') }}"
            class="btn btn-outline-secondary btn-sm px-3"
            >‚Üê Back</a
          >
        </div>

        <hr />

        <div class="row g-4">
          <!-- Chat Window -->
          <div class="col-md-8">
            <div class="chat-window" id="chat-window"></div>

            <div class="mt-3 d-flex gap-2">
              <input
                id="chat-input"
                class="form-control"
                placeholder="Write something..."
              />
              <button class="btn btn-primary px-4" id="chat-send">Send</button>
            </div>
          </div>

          <!-- Music Recommendation Panel -->
          <div class="col-md-4">
            <div class="sidebar-card p-3">
              <h5 class="fw-bold">üéµ Mood-Based Music</h5>

              <button
                class="btn btn-danger w-100 mt-2"
                onclick="requestMusic('hindi')"
              >
                üéß Hindi Songs
              </button>

              <button
                class="btn btn-primary w-100 mt-2"
                onclick="requestMusic('punjabi')"
              >
                üéµ Punjabi Songs
              </button>

              <button
                class="btn btn-success w-100 mt-2"
                onclick="requestMusic('english')"
              >
                üé∂ English Songs
              </button>

              <div id="music-result" class="mt-3 small-muted"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chat bubble example (temporary demo logic) -->
    <script>
      let lastEmotion = null; // stores latest detected emotion from chatbot
      const chatWindow = document.getElementById("chat-window");
      const chatInput = document.getElementById("chat-input");
      const chatSend = document.getElementById("chat-send");

      const sidebarEmotion = document.getElementById("sidebar-emotion");
      const sidebarTips = document.getElementById("sidebar-tips");

      function addMessage(text, sender) {
        const bubble = document.createElement("div");
        bubble.classList.add(
          "chat-bubble",
          sender === "user" ? "user-bubble" : "bot-bubble"
        );
        bubble.innerText = text;
        chatWindow.appendChild(bubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function sendToChatbot(message) {
        addMessage("Typing...", "bot"); // keep visual indicator

        try {
          const res = await fetch("/chatbot", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message }),
          });

          // read raw text first (so we can log it if JSON parse fails)
          const raw = await res.text();
          console.log("Raw /chatbot response:", res.status, raw);

          let data;
          try {
            data = JSON.parse(raw);
          } catch (parseErr) {
            console.error("Failed to parse JSON from /chatbot:", parseErr);
            // remove typing bubble and show user friendly error
            chatWindow.lastChild.remove();
            addMessage("‚ö†Ô∏è Invalid response from server.", "bot");
            return;
          }

          // remove "Typing..." bubble
          if (chatWindow.lastChild) chatWindow.lastChild.remove();

          // Show bot reply
          addMessage(data.bot_reply || "‚ö†Ô∏è No reply from chatbot.", "bot");

          // Save emotion safely
          if (data.emotion) {
            lastEmotion = String(data.emotion).toLowerCase();
            console.log("lastEmotion set to:", lastEmotion);
          } else {
            lastEmotion = "unknown";
            console.log(
              "no emotion present in response, set lastEmotion to 'unknown'"
            );
          }

          // (Optional) show tips if present
          if (Array.isArray(data.tips) && data.tips.length) {
            // insert tips UI or console log
            console.log("Tips:", data.tips);
          }
        } catch (err) {
          console.error("Network or fetch error:", err);
          // remove typing bubble and display error
          if (chatWindow.lastChild) chatWindow.lastChild.remove();
          addMessage(
            "‚ö†Ô∏è Error connecting to chatbot. See console/network tab.",
            "bot"
          );
        }
      }

      chatSend.addEventListener("click", () => {
        const text = chatInput.value.trim();
        if (!text) return;

        addMessage(text, "user");
        chatInput.value = "";

        sendToChatbot(text);
      });

      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") chatSend.click();
      });

      async function requestMusic(language) {
  const musicBox = document.getElementById("music-result");

  if (!lastEmotion) {
    musicBox.innerHTML =
      "‚ùó Please chat first so I can detect your emotion.";
    return;
  }

  musicBox.innerHTML = "‚è≥ Getting music suggestions...";

  try {
    const res = await fetch("/music_recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        emotion: lastEmotion,
        language: language
      })
    });

    const data = await res.json();

    // Clean response
    const text = data.recommendation.replace(/\*/g, "");
    const lines = text.split("\n");

    let html = "";

    lines.forEach(line => {
      line = line.trim();

      // ‚ùå Skip empty lines
      if (!line) return;

      // ‚ùå Skip heading / explanation lines
      if (
        line.toLowerCase().startsWith("here are") ||
        line.toLowerCase().includes("songs for") ||
        line.toLowerCase().includes("lyrics") ||
        line.toLowerCase().includes("melody") ||
        line.toLowerCase().includes("vibe") ||
        line.toLowerCase().includes("depth") ||
        line.toLowerCase().includes("comfort") ||
        line.toLowerCase().includes("peace")
      ) {
        return;
      }

      // ‚úÖ Keep ONLY song name (before :)
      const songName = line.split(":")[0].trim();

      // Extra safety: ignore very long sentences
      if (songName.split(" ").length > 8) return;

      const ytUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(songName + " song")}`;

      html += `
        üéµ <a href="${ytUrl}" target="_blank" class="d-block text-decoration-none">
          ${songName}
        </a>
      `;
    });

    musicBox.innerHTML = html || "üéµ No songs available.";

  } catch (err) {
    musicBox.innerHTML = "‚ö†Ô∏è Could not fetch music suggestions.";
  }
}


    </script>
  </body>
</html>
